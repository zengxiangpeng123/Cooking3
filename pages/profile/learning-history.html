<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ è®°å½• - ç‚’èœå­¦ä¹ å¹³å°</title>
    <meta name="description" content="æŸ¥çœ‹æ‚¨çš„å®Œæ•´å­¦ä¹ å†å²è®°å½•">
    
    <!-- CSS æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="../../css/base/reset.css">
    <link rel="stylesheet" href="../../css/base/variables.css">
    <link rel="stylesheet" href="../../css/base/base.css">
    <link rel="stylesheet" href="../../css/components/header.css">
    <link rel="stylesheet" href="../../css/components/footer.css">
    <link rel="stylesheet" href="../../css/components/card.css">
    <link rel="stylesheet" href="../../css/components/cool-search.css">
    <link rel="stylesheet" href="../../css/pages/profile.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    
    <style>
        .learning-history {
            min-height: 60vh;
            padding: 40px 0;
        }
        
        .history-filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .history-filters__content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .history-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .history-card__image {
            height: 180px;
            position: relative;
            overflow: hidden;
        }
        
        .history-card__image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .history-card__time-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .history-card__content {
            padding: 20px;
        }
        
        .history-card__title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .history-card__desc {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .history-card__meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #888;
        }
        
        .history-card__actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-card__btn {
            flex: 1;
            margin-right: 8px;
            padding: 10px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .history-card__btn:hover {
            background: #e55a2b;
        }
        
        .history-card__quick-actions {
            display: flex;
            gap: 8px;
        }
        
        .quick-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quick-btn:hover {
            background: #f8f9fa;
            border-color: #ff6b35;
        }
        
        .quick-btn.favorite.active {
            background: #ff6b35;
            color: white;
            border-color: #ff6b35;
        }
        
        .empty-history {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .pagination-info {
            text-align: center;
            margin: 30px 0;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .history-filters__content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .history-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="header">
        <div class="container">
            <div class="header__content">
                <div class="header__logo">
                    <a href="../../main.html" class="logo">
                        <img src="../../data/imgs/å›¾æ ‡.png" alt="ç‚’èœå­¦ä¹ å¹³å°" class="logo__icon">
                        <span class="logo__text">ç‚’èœå­¦ä¹ å¹³å°</span>
                    </a>
                </div>
                
                <nav class="header__nav">
                    <ul class="nav__list">
                        <li class="nav__item">
                            <a href="../../main.html" class="nav__link">é¦–é¡µ</a>
                        </li>
                        <li class="nav__item">
                            <a href="../recipes/list.html" class="nav__link">èœè°±å¤§å…¨</a>
                        </li>
                        <li class="nav__item">
                            <a href="../guide/basics.html" class="nav__link">çƒ¹é¥ªæŒ‡å—</a>
                        </li>
                        <li class="nav__item">
                            <a href="../forum/index.html" class="nav__link">ç¾é£Ÿè®ºå›</a>
                        </li>
                        <li class="nav__item">
                            <a href="favorites.html" class="nav__link">æˆ‘çš„æ”¶è—</a>
                        </li>
                        <li class="nav__item">
                            <a href="center.html" class="nav__link nav__link--active">ç”¨æˆ·ä¸­å¿ƒ</a>
                        </li>
                    </ul>
                </nav>
                
                <div class="header__search">
                    <form class="search__form" id="searchForm">
                        <input type="text" class="search__input" placeholder="æœç´¢èœè°±æˆ–é£Ÿæ..." id="searchInput">
                        <button type="submit" class="search__btn">
                            <span class="search__icon">ğŸ”</span>
                        </button>
                    </form>
                </div>
                
                <button class="header__menu-btn" id="mobileMenuBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main">
        <section class="page-header" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; padding: 60px 0;">
            <div class="container" style="text-align: center;">
                <h1 class="page-title" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 15px;">ğŸ“š å­¦ä¹ è®°å½•</h1>
                <p class="page-description" style="font-size: 1.2rem; opacity: 0.95;">æˆ‘çš„èœè°±å­¦ä¹ å†ç¨‹</p>
                <div style="margin-top: 20px;">
                    <a href="center.html" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); text-decoration: none; padding: 10px 20px; border-radius: 6px; margin-right: 10px;">
                        â† è¿”å›ç”¨æˆ·ä¸­å¿ƒ
                    </a>
                </div>
            </div>
        </section>

        <section class="learning-history">
            <div class="container">
                <!-- ç­›é€‰å’Œæ’åº -->
                <div class="history-filters">
                    <div class="history-filters__content">
                        <div class="filter-group">
                            <label>æ’åºæ–¹å¼ï¼š</label>
                            <select id="sortSelect" class="filter__select">
                                <option value="newest">æœ€æ–°å­¦ä¹ </option>
                                <option value="oldest">æœ€æ—©å­¦ä¹ </option>
                                <option value="name">æŒ‰åç§°æ’åº</option>
                                <option value="cuisine">æŒ‰èœç³»åˆ†ç±»</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>ç­›é€‰èœç³»ï¼š</label>
                            <select id="cuisineFilter" class="filter__select">
                                <option value="all">å…¨éƒ¨èœç³»</option>
                                <option value="sichuan">å·èœ</option>
                                <option value="cantonese">ç²¤èœ</option>
                                <option value="hunan">æ¹˜èœ</option>
                                <option value="shandong">é²èœ</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>æ—¶é—´èŒƒå›´ï¼š</label>
                            <select id="timeFilter" class="filter__select">
                                <option value="all">å…¨éƒ¨æ—¶é—´</option>
                                <option value="today">ä»Šå¤©</option>
                                <option value="week">æœ¬å‘¨</option>
                                <option value="month">æœ¬æœˆ</option>
                            </select>
                        </div>
                        
                        <div class="history-stats">
                            <span id="historyCount">å…± 0 æ¡è®°å½•</span>
                        </div>
                    </div>
                </div>

                <!-- å­¦ä¹ è®°å½•ç½‘æ ¼ -->
                <div class="history-grid" id="historyGrid">
                    <!-- å­¦ä¹ è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- åˆ†é¡µä¿¡æ¯ -->
                <div class="pagination-info" id="paginationInfo"></div>

                <!-- ç©ºçŠ¶æ€ -->
                <div class="empty-history" id="emptyHistory" style="display: none;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ“š</div>
                    <h3>è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</h3>
                    <p>æµè§ˆèœè°±è¯¦æƒ…é¡µé¢å³ä¼šè‡ªåŠ¨è®°å½•å­¦ä¹ å†å²</p>
                    <a href="../recipes/list.html" class="btn btn--primary" style="margin-top: 20px;">
                        ğŸ³ å¼€å§‹å­¦ä¹ èœè°±
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- é¡µé¢åº•éƒ¨ -->
    <footer class="footer">
        <div class="container">
            <div class="footer__content">
                <div class="footer__section">
                    <h3 class="footer__title">å…³äºæˆ‘ä»¬</h3>
                    <p class="footer__text">ç‚’èœå­¦ä¹ å¹³å°è‡´åŠ›äºä¼ æ’­ä¸­åç¾é£Ÿæ–‡åŒ–ï¼Œè®©æ¯ä¸ªäººéƒ½èƒ½è½»æ¾å­¦ä¼šåšèœã€‚</p>
                </div>
                <div class="footer__section">
                    <h3 class="footer__title">å¿«é€Ÿé“¾æ¥</h3>
                    <ul class="footer__links">
                        <li><a href="../recipes/list.html">èœè°±å¤§å…¨</a></li>
                        <li><a href="../guide/basics.html">çƒ¹é¥ªåŸºç¡€</a></li>
                        <li><a href="center.html">ç”¨æˆ·ä¸­å¿ƒ</a></li>
                    </ul>
                </div>
                <div class="footer__section">
                    <h3 class="footer__title">è”ç³»æ–¹å¼</h3>
                    <ul class="footer__contact">
                        <li>ğŸ“§ contact@cooking-platform.com</li>
                        <li>ğŸ“± 400-123-4567</li>
                    </ul>
                </div>
            </div>
            <div class="footer__bottom">
                <p>&copy; 2024 ç‚’èœå­¦ä¹ å¹³å°. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript æ–‡ä»¶ -->
    <script src="../../js/utils/global-search.js"></script>
    <script src="../../js/utils/storage.js"></script>
    <script src="../../js/utils/dom.js"></script>
    <script src="../../js/data/recipes.js"></script>
    <script src="../../js/utils/user-center-manager.js"></script>

    <script>
        class LearningHistoryPage {
            constructor() {
                this.currentPage = 1;
                this.itemsPerPage = 12;
                this.currentSort = 'newest';
                this.currentCuisine = 'all';
                this.currentTime = 'all';
                this.allHistory = [];
                this.filteredHistory = [];
                this.init();
            }

            init() {
                this.loadHistory();
                this.bindEvents();
                this.applyFiltersAndRender();
            }

            loadHistory() {
                const historyData = JSON.parse(localStorage.getItem('learning_history') || '[]');
                
                this.allHistory = historyData.map(item => ({
                    ...item,
                    timestamp: new Date(item.timestamp),
                    recipe: this.getRecipeById(item.recipeId)
                })).filter(item => item.recipe);
                
                console.log(`åŠ è½½äº† ${this.allHistory.length} æ¡å­¦ä¹ è®°å½•`);
            }

            bindEvents() {
                // æ’åºé€‰æ‹©
                document.getElementById('sortSelect').addEventListener('change', (e) => {
                    this.currentSort = e.target.value;
                    this.applyFiltersAndRender();
                });

                // èœç³»ç­›é€‰
                document.getElementById('cuisineFilter').addEventListener('change', (e) => {
                    this.currentCuisine = e.target.value;
                    this.applyFiltersAndRender();
                });

                // æ—¶é—´ç­›é€‰
                document.getElementById('timeFilter').addEventListener('change', (e) => {
                    this.currentTime = e.target.value;
                    this.applyFiltersAndRender();
                });

                // æ”¶è—æŒ‰é’®äº‹ä»¶å§”æ‰˜
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('favorite-btn')) {
                        e.stopPropagation();
                        const recipeId = e.target.getAttribute('data-recipe-id');
                        this.toggleFavorite(recipeId, e.target);
                    } else if (e.target.classList.contains('share-btn')) {
                        e.stopPropagation();
                        const recipeId = e.target.getAttribute('data-recipe-id');
                        this.shareRecipe(recipeId);
                    }
                });
            }

            applyFiltersAndRender() {
                this.filteredHistory = this.filterHistory();
                this.sortHistory();
                this.renderHistory();
                this.updateStats();
            }

            filterHistory() {
                let filtered = [...this.allHistory];

                // èœç³»ç­›é€‰
                if (this.currentCuisine !== 'all') {
                    filtered = filtered.filter(item => item.recipe.cuisine === this.currentCuisine);
                }

                // æ—¶é—´ç­›é€‰
                if (this.currentTime !== 'all') {
                    const now = new Date();
                    filtered = filtered.filter(item => {
                        switch (this.currentTime) {
                            case 'today':
                                return item.timestamp.toDateString() === now.toDateString();
                            case 'week':
                                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                                return item.timestamp >= weekAgo;
                            case 'month':
                                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                                return item.timestamp >= monthAgo;
                            default:
                                return true;
                        }
                    });
                }

                return filtered;
            }

            sortHistory() {
                switch (this.currentSort) {
                    case 'newest':
                        this.filteredHistory.sort((a, b) => b.timestamp - a.timestamp);
                        break;
                    case 'oldest':
                        this.filteredHistory.sort((a, b) => a.timestamp - b.timestamp);
                        break;
                    case 'name':
                        this.filteredHistory.sort((a, b) => a.recipe.title.localeCompare(b.recipe.title, 'zh-CN'));
                        break;
                    case 'cuisine':
                        this.filteredHistory.sort((a, b) => a.recipe.cuisine.localeCompare(b.recipe.cuisine));
                        break;
                }
            }

            renderHistory() {
                const container = document.getElementById('historyGrid');
                const emptyState = document.getElementById('emptyHistory');

                if (this.filteredHistory.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                container.style.display = 'grid';
                emptyState.style.display = 'none';

                container.innerHTML = this.filteredHistory.map(item => 
                    this.createHistoryCard(item)
                ).join('');
            }

            createHistoryCard(item) {
                const recipe = item.recipe;
                const cuisineInfo = this.getCuisineInfo(recipe.cuisine);
                const timeDiff = this.getTimeAgo(item.timestamp);
                const isFavorite = this.getFavorites().includes(recipe.id);

                return `
                    <div class="history-card">
                        <div class="history-card__image">
                            <img src="/cooking-platform/data/imgs/${this.getCuisineFolderName(recipe.cuisine)}/${recipe.title}.png" 
                                 alt="${recipe.title}"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div style="
                                display: none;
                                width: 100%; 
                                height: 100%; 
                                background: linear-gradient(135deg, ${cuisineInfo.color}, ${this.darkenColor(cuisineInfo.color, 20)});
                                align-items: center;
                                justify-content: center;
                                color: white;
                            ">
                                <div style="text-align: center;">
                                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${cuisineInfo.icon}</div>
                                    <div style="font-size: 1rem; font-weight: 600;">${recipe.title}</div>
                                </div>
                            </div>
                            
                            <div class="history-card__time-badge">${timeDiff}</div>
                        </div>
                        
                        <div class="history-card__content">
                            <h3 class="history-card__title">${recipe.title}</h3>
                            <p class="history-card__desc">${recipe.description.substring(0, 80)}...</p>
                            
                            <div class="history-card__meta">
                                <span>${cuisineInfo.name} â€¢ ${recipe.difficulty} â€¢ ${recipe.cookTime}</span>
                                <span>â­ ${recipe.rating || '4.5'}</span>
                            </div>
                            
                            <div class="history-card__actions">
                                <button class="history-card__btn" onclick="window.location.href='../recipes/detail.html?id=${recipe.id}'">
                                    å†æ¬¡å­¦ä¹ 
                                </button>
                                
                                <div class="history-card__quick-actions">
                                    <button class="quick-btn favorite-btn ${isFavorite ? 'active' : ''}" 
                                            data-recipe-id="${recipe.id}" 
                                            title="${isFavorite ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}">
                                        ${isFavorite ? 'â™¥' : 'â™¡'}
                                    </button>
                                    <button class="quick-btn share-btn" 
                                            data-recipe-id="${recipe.id}" 
                                            title="åˆ†äº«">
                                        ğŸ”—
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            updateStats() {
                const countElement = document.getElementById('historyCount');
                if (countElement) {
                    countElement.textContent = `å…± ${this.filteredHistory.length} æ¡è®°å½•`;
                }
            }

            toggleFavorite(recipeId, btn) {
                const favorites = this.getFavorites();
                const isFavorite = favorites.includes(recipeId);
                const recipe = this.getRecipeById(recipeId);

                if (isFavorite) {
                    const newFavorites = favorites.filter(id => id !== recipeId);
                    localStorage.setItem('favorites', JSON.stringify(newFavorites));
                    btn.classList.remove('active');
                    btn.innerHTML = 'â™¡';
                    btn.title = 'æ”¶è—';
                    this.showToast(`å·²å–æ¶ˆæ”¶è— "${recipe.title}"`, 'info');
                } else {
                    favorites.push(recipeId);
                    localStorage.setItem('favorites', JSON.stringify(favorites));
                    btn.classList.add('active');
                    btn.innerHTML = 'â™¥';
                    btn.title = 'å–æ¶ˆæ”¶è—';
                    this.showToast(`å·²æ”¶è— "${recipe.title}"`, 'success');
                }
            }

            shareRecipe(recipeId) {
                const recipe = this.getRecipeById(recipeId);
                if (!recipe) return;

                const shareUrl = `${window.location.origin}/cooking-platform/pages/recipes/detail.html?id=${recipeId}`;
                const shareText = `æˆ‘åœ¨ç‚’èœå­¦ä¹ å¹³å°å­¦ä¹ äº†ã€Œ${recipe.title}ã€ï¼Œæ¨èç»™ä½ ï¼`;

                if (navigator.share) {
                    navigator.share({
                        title: recipe.title,
                        text: shareText,
                        url: shareUrl
                    });
                } else {
                    const fullText = `${shareText}\n${shareUrl}`;
                    navigator.clipboard.writeText(fullText).then(() => {
                        this.showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    }).catch(() => {
                        prompt('è¯·å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ†äº«ï¼š', fullText);
                    });
                }
            }

            // è¾…åŠ©æ–¹æ³•
            getRecipeById(recipeId) {
                if (window.RecipeData && window.RecipeData.recipes) {
                    return window.RecipeData.recipes.find(recipe => recipe.id === recipeId);
                }
                return null;
            }

            getFavorites() {
                return JSON.parse(localStorage.getItem('favorites') || '[]');
            }

            getCuisineInfo(cuisine) {
                const cuisines = {
                    'sichuan': { name: 'å·èœ', icon: 'ğŸŒ¶ï¸', color: '#ff4757' },
                    'cantonese': { name: 'ç²¤èœ', icon: 'ğŸ¦', color: '#3742fa' },
                    'hunan': { name: 'æ¹˜èœ', icon: 'ğŸ”¥', color: '#ff3838' },
                    'shandong': { name: 'é²èœ', icon: 'ğŸŸ', color: '#2f3542' }
                };
                return cuisines[cuisine] || { name: 'å…¶ä»–', icon: 'ğŸ½ï¸', color: '#57606f' };
            }

            getCuisineFolderName(cuisine) {
                const mapping = {
                    'sichuan': 'å·èœ',
                    'hunan': 'æ¹˜èœ', 
                    'cantonese': 'ç²µèœ',
                    'shandong': 'é²èœ'
                };
                return mapping[cuisine] || 'å·èœ';
            }

            darkenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = Math.max(0, Math.min(255, (num >> 16) - amt));
                const G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) - amt));
                const B = Math.max(0, Math.min(255, (num & 0x0000FF) - amt));
                return "#" + ((1 << 24) + (R << 16) + (G << 8) + B).toString(16).slice(1);
            }

            getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMins = Math.floor(diffMs / (1000 * 60));

                if (diffDays > 0) {
                    return `${diffDays}å¤©å‰`;
                } else if (diffHours > 0) {
                    return `${diffHours}å°æ—¶å‰`;
                } else if (diffMins > 0) {
                    return `${diffMins}åˆ†é’Ÿå‰`;
                } else {
                    return 'åˆšåˆš';
                }
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: ${type === 'success' ? '#4caf50' : '#2196f3'};
                    color: white;
                    padding: 15px 25px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 10000;
                    font-size: 14px;
                    opacity: 0;
                    transform: translateX(100px);
                    transition: all 0.3s ease;
                `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '1';
                    toast.style.transform = 'translateX(0)';
                }, 10);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100px)';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new LearningHistoryPage();
        });
    </script>
</body>
</html>
